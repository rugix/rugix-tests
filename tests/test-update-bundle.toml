[[systems]]
system  = "customized-arm64"
ssh = { private-key = "./keys/id_rsa" }

[[steps]]
action = "run"
description = "check that installation fails without --insecure-skip-bundle-verification"
stdin-file = "./build/customized-arm64/system.rugixb"
script = """
#!/bin/bash
set -euo pipefail
if rugix-ctrl update install --reboot no -; then
    echo "ERROR: Installation succeeded without bundle verification!"
    exit 1
else
    echo "SUCCESS: Installation failed as expected without bundle verification."
fi
"""

[[steps]]
action = "run"
description = "check system state prior to update"
script = """
#!/bin/bash
set -euo pipefail
rugix-system-assert ".boot.defaultGroup" "a"
rugix-system-assert ".boot.activeGroup" "a"
"""

[[steps]]
action = "run"
description = "install a system update"
stdin-file = "./build/customized-arm64/system.rugixb"
# Rebooting may cause the SSH client to disconnect while executing the script.
may-disconnect = true
script = """
#!/bin/bash
set -euo pipefail
rugix-ctrl update install --insecure-skip-bundle-verification -
"""

[[steps]]
action = "wait"
duration = 10

[[steps]]
action = "run"
description = "check whether the update has been installed"
script = """
#!/bin/bash
set -euo pipefail
rugix-system-assert ".boot.defaultGroup" "a"
rugix-system-assert ".boot.activeGroup" "b"
rugix-ctrl system commit
rugix-system-assert ".boot.defaultGroup" "b"
rugix-system-assert ".boot.activeGroup" "b"
"""

[[steps]]
action = "run"
description = "install a system update"
stdin-file = "./build/customized-arm64/system.rugixb"
# Rebooting may cause the SSH client to disconnect while executing the script.
may-disconnect = true
script = """
#!/bin/bash
set -euo pipefail
rugix-ctrl update install --insecure-skip-bundle-verification -
"""

[[steps]]
action = "wait"
duration = 10

[[steps]]
action = "run"
description = "check whether the update has been installed"
script = """
#!/bin/bash
set -euo pipefail
rugix-system-assert ".boot.defaultGroup" "b"
rugix-system-assert ".boot.activeGroup" "a"
rugix-ctrl system commit
rugix-system-assert ".boot.defaultGroup" "a"
rugix-system-assert ".boot.activeGroup" "a"
"""

[[steps]]
action = "run"
description = "install a system update"
stdin-file = "./build/customized-arm64/system.rugixb"
# Rebooting may cause the SSH client to disconnect while executing the script.
may-disconnect = true
script = """
#!/bin/bash
set -euo pipefail
rugix-ctrl update install --insecure-skip-bundle-verification -
"""

[[steps]]
action = "wait"
duration = 10

[[steps]]
action = "run"
description = "check whether the update has been installed"
script = """
#!/bin/bash
set -euo pipefail
rugix-system-assert ".boot.defaultGroup" "a"
rugix-system-assert ".boot.activeGroup" "b"
rugix-ctrl system commit
rugix-system-assert ".boot.defaultGroup" "b"
rugix-system-assert ".boot.activeGroup" "b"
"""